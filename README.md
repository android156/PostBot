# Telegram Бот для Расчета Стоимости Доставки

Профессиональное приложение на Python для автоматического расчета стоимости доставки через Telegram бота с интеграцией TOP-EX API.

## 🏗️ Архитектура Проекта

Проект построен в соответствии с принципами **SOLID** и использует **чистую архитектуру** с четким разделением ответственности.

### Структура Проекта

```
src/
├── interfaces/          # Абстракции (Принцип DIP)
│   ├── i_config.py
│   ├── i_excel_processor.py  
│   ├── i_api_client.py
│   ├── i_result_generator.py
│   └── i_bot_service.py
├── models/             # Модели данных
│   ├── route.py
│   └── shipping_calculation.py
├── implementations/    # Конкретные реализации
│   ├── config_manager.py
│   ├── excel_processor.py
│   ├── topex_api_client.py
│   └── result_generator.py
├── services/          # Бизнес-логика
│   └── bot_service.py
└── main.py           # Точка входа с DI контейнером
```

## 📋 Детальное Описание Модулей

### 🔧 Интерфейсы (src/interfaces/)

#### IConfig (i_config.py)
**Назначение:** Абстракция для управления конфигурацией приложения

**Основные методы:**
- `get_telegram_token() -> Optional[str]` - возвращает токен Telegram бота
- `get_api_credentials() -> Dict[str, str]` - учетные данные TOP-EX API  
- `get_file_processing_settings() -> Dict[str, Any]` - настройки обработки файлов
- `get_api_settings() -> Dict[str, Any]` - настройки работы с API
- `validate_configuration() -> bool` - проверка корректности конфигурации
- `get_logging_settings() -> Dict[str, Any]` - параметры логирования

**Переменные окружения:**
- `TELEGRAM_BOT_TOKEN` - токен Telegram бота
- `TOPEX_EMAIL` - email для TOP-EX API
- `TOPEX_PASSWORD` - пароль для TOP-EX API
- `TOPEX_API_BASE` - базовый URL API (по умолчанию: https://api.top-ex.ru)
- `MAX_FILE_SIZE` - максимальный размер файла в байтах
- `API_TIMEOUT` - таймаут запросов в секундах
- `LOG_LEVEL` - уровень логирования (DEBUG, INFO, WARNING, ERROR)

#### IExcelProcessor (i_excel_processor.py)
**Назначение:** Абстракция для обработки Excel файлов с маршрутами

**Основные методы:**
- `process_file(file_path: str) -> List[Dict[str, Any]]` - обрабатывает Excel файл
- `validate_file_format(file_path: str) -> bool` - проверяет формат файла
- `get_supported_column_names() -> Dict[str, List[str]]` - поддерживаемые названия колонок

**Поддерживаемые форматы файлов:** .xlsx, .xls

**Поддерживаемые названия колонок:**
- Отправление: "откуда", "отправитель", "город отправления", "from", "origin"
- Назначение: "куда", "получатель", "город назначения", "to", "destination"

#### IApiClient (i_api_client.py)
**Назначение:** Абстракция для работы с API доставки

**Основные методы:**
- `authenticate() -> bool` - выполняет аутентификацию
- `calculate_shipping_cost(origin, destination, weight) -> Dict[str, Any]` - расчет стоимости
- `get_available_cities() -> List[Dict[str, str]]` - список доступных городов
- `is_authenticated() -> bool` - проверка аутентификации
- `close() -> None` - освобождение ресурсов

#### IResultGenerator (i_result_generator.py)
**Назначение:** Абстракция для генерации файлов результатов

**Основные методы:**
- `generate_result_file(results, format) -> str` - создает файл результатов
- `get_supported_formats() -> List[str]` - поддерживаемые форматы
- `create_summary_sheet(results) -> Dict[str, Any]` - создает сводку

**Поддерживаемые форматы:** xlsx, csv, json

#### IBotService (i_bot_service.py)
**Назначение:** Абстракция для сервиса Telegram бота

**Основные методы:**
- `handle_start_command(update, context)` - обработка команды /start
- `handle_help_command(update, context)` - обработка команды /help
- `handle_document(update, context)` - обработка загруженных файлов
- `handle_text_message(update, context)` - обработка текстовых сообщений
- `process_shipping_calculation(routes_data) -> Dict[str, Any]` - расчет доставки
- `start_bot()` - запуск бота
- `stop_bot()` - остановка бота

### 📊 Модели Данных (src/models/)

#### Route (route.py)
**Назначение:** Модель маршрута доставки

**Атрибуты:**
- `origin: str` - город отправления
- `destination: str` - город назначения  
- `row_index: int` - номер строки в Excel файле
- `origin_code: Optional[str]` - код города отправления
- `destination_code: Optional[str]` - код города назначения

**Методы:**
- `is_valid() -> bool` - проверка валидности маршрута
- `has_city_codes() -> bool` - проверка наличия кодов городов
- `get_display_name() -> str` - читаемое представление маршрута
- `to_dict() -> dict` - конвертация в словарь

#### ShippingOffer (shipping_calculation.py)
**Назначение:** Модель предложения доставки от компании

**Атрибуты:**
- `company_name: str` - название транспортной компании
- `price: float` - стоимость доставки в рублях
- `delivery_days: int` - срок доставки в днях
- `tariff_name: str` - название тарифа
- `weight: int` - вес груза в граммах
- `additional_info: Dict[str, Any]` - дополнительная информация

**Методы:**
- `get_price_per_kg() -> float` - стоимость за килограмм
- `is_better_than(other) -> bool` - сравнение с другим предложением
- `to_dict() -> Dict[str, Any]` - конвертация в словарь

#### WeightCategoryResult (shipping_calculation.py)
**Назначение:** Результат расчета для одной весовой категории

**Атрибуты:**
- `weight: int` - вес в граммах
- `offers: List[ShippingOffer]` - список предложений
- `cheapest_offer: Optional[ShippingOffer]` - самое дешевое предложение
- `calculation_error: Optional[str]` - ошибка расчета

**Методы:**
- `add_offer(offer)` - добавление предложения
- `has_offers() -> bool` - проверка наличия предложений
- `get_weight_kg() -> float` - вес в килограммах
- `to_dict() -> Dict[str, Any]` - конвертация в словарь

#### RouteCalculationResult (shipping_calculation.py)
**Назначение:** Результат расчета для одного маршрута

**Атрибуты:**
- `route: Route` - маршрут доставки
- `weight_results: Dict[int, WeightCategoryResult]` - результаты по весам
- `calculation_time: datetime` - время расчета
- `total_offers: int` - общее количество предложений
- `successful_weights: List[int]` - веса с успешными расчетами

**Методы:**
- `add_weight_result(weight_result)` - добавление результата по весу
- `get_all_cheapest_offers() -> List[ShippingOffer]` - лучшие предложения
- `get_best_weight_category() -> Optional[int]` - лучшая весовая категория
- `is_successful() -> bool` - проверка успешности расчета
- `to_dict() -> Dict[str, Any]` - конвертация в словарь

### ⚙️ Реализации (src/implementations/)

#### ConfigManager (config_manager.py)
**Назначение:** Конкретная реализация управления конфигурацией

**Функциональность:**
- Загрузка настроек из переменных окружения
- Валидация конфигурации при инициализации
- Настройки по умолчанию для всех параметров
- Создание недостающих директорий
- Безопасное логирование (без секретных данных)

**Настройки по умолчанию:**
- API timeout: 30 секунд
- Максимальный размер файла: 10 MB
- Количество повторов: 3
- Задержка между запросами: 1.0 секунда
- Весовые категории: 500г, 1кг, 2кг, 5кг, 10кг

**Дополнительные методы:**
- `get_weight_categories() -> list[int]` - весовые категории для тестирования
- `to_dict() -> Dict[str, Any]` - полная конфигурация для отладки

#### ExcelProcessor (excel_processor.py)
**Назначение:** Обработка Excel файлов с маршрутами доставки

**Функциональность:**
- Поддержка форматов .xlsx и .xls
- Автоматическое определение колонок по названиям
- Нормализация данных (удаление пробелов, валидация)
- Обработка пустых значений и строк
- Многоязычная поддержка названий колонок
- Подробное логирование процесса обработки

**Настройки pandas:**
- Engine: openpyxl для .xlsx, xlrd для .xls
- Автоматическое определение заголовков
- Обработка различных представлений пустых значений
- Приведение названий колонок к нижнему регистру

**Приватные методы:**
- `_read_excel_file(file_path)` - чтение файла с правильными настройками
- `_find_required_columns(df)` - поиск необходимых колонок
- `_extract_routes_data(df, origin_col, destination_col)` - извлечение маршрутов

#### TopExApiClient (topex_api_client.py)
**Назначение:** Клиент для работы с TOP-EX API

**Функциональность:**
- Автоматическая аутентификация и обновление токенов
- Обработка rate limiting (задержки между запросами)
- Кэширование токенов с буферным временем
- Обработка ошибок сети и API
- URL-кодирование токенов для безопасности
- Парсинг ответов API в модели данных

**Настройки аутентификации:**
- Буферное время: 300 секунд (5 минут до истечения)
- Автоматическое обновление токенов
- Обработка ошибок аутентификации

**Приватные методы:**
- `_ensure_session()` - ленивое создание HTTP сессии
- `_resolve_city_code(city_input)` - преобразование названий в коды
- `_perform_calculation(origin_code, destination_code, weight)` - выполнение расчета
- `_parse_shipping_offers(api_data, weight)` - парсинг ответа API
- `_create_error_result(error_type, error_message)` - создание объекта ошибки

#### ExcelResultGenerator (result_generator.py)
**Назначение:** Генерация Excel файлов с результатами

**Функциональность:**
- Создание многолистовых Excel файлов
- Форматирование данных для удобства чтения
- Генерация сводных листов со статистикой
- Поддержка различных форматов экспорта
- Сортировка результатов по различным критериям
- Расчет метрик и аналитики

**Структура Excel файла:**
- Лист "Сводка" - общая статистика
- Лист "Результаты" - основные данные
- Листы "Вес_Xкг" - детализация по весовым категориям

**Приватные методы:**
- `_generate_excel_file(results, file_path)` - создание Excel файла
- `_generate_csv_file(results, file_path)` - создание CSV файла
- `_generate_json_file(results, file_path)` - создание JSON файла
- `_prepare_main_data(results)` - подготовка основных данных
- `_prepare_weight_data(results, target_weight)` - данные по весу
- `_get_weight_categories(results)` - извлечение весовых категорий

### 🔄 Сервисы (src/services/)

#### BotService (bot_service.py)
**Назначение:** Основная бизнес-логика Telegram бота

**Функциональность:**
- Координация всех компонентов системы
- Обработка команд и сообщений пользователей
- Управление жизненным циклом обработки файлов
- Статистика и мониторинг работы
- Генерация пользовательских сообщений
- Обработка ошибок с пользовательскими уведомлениями

**Основной алгоритм обработки файлов:**
1. Валидация загруженного файла (размер, формат)
2. Скачивание и обработка Excel файла
3. Извлечение маршрутов из данных
4. Расчет стоимости для всех весовых категорий
5. Поиск лучших предложений для каждого веса
6. Генерация Excel файла с результатами
7. Отправка результатов пользователю

**Статистика работы:**
- `total_files_processed` - количество обработанных файлов
- `total_routes_calculated` - количество рассчитанных маршрутов  
- `total_api_calls` - количество вызовов API
- `start_time` - время запуска сервиса

**Приватные методы:**
- `_create_welcome_message()` - создание приветственного сообщения
- `_create_help_message()` - создание справочного сообщения
- `_analyze_text_message(message_text)` - анализ текстовых сообщений
- `_validate_uploaded_file(document)` - валидация файлов
- `_download_and_process_file(document, context)` - скачивание и обработка
- `_process_api_result(api_result, weight)` - обработка ответа API
- `_create_calculation_summary(results)` - создание сводки результатов
- `_generate_result_file(calculation_results)` - генерация файла результатов
- `_send_results_to_user(update, result_file_path, results)` - отправка результатов

### 🚀 Точка Входа (src/main.py)

#### ApplicationContainer
**Назначение:** Контейнер внедрения зависимостей (DI Container)

**Функциональность:**
- Создание всех компонентов приложения в правильном порядке
- Управление жизненным циклом зависимостей
- Валидация конфигурации при старте
- Освобождение ресурсов при завершении
- Логирование процесса инициализации

**Порядок создания компонентов:**
1. `ConfigManager` - конфигурация (независимый)
2. `ExcelProcessor` - обработка Excel (независимый)
3. `TopExApiClient` - API клиент (зависит от конфигурации)
4. `ExcelResultGenerator` - генератор результатов (независимый)
5. `BotService` - сервис бота (зависит от всех предыдущих)

**Методы контейнера:**
- `get_bot_service() -> IBotService` - получение основного сервиса
- `get_config() -> IConfig` - получение конфигурации
- `cleanup()` - освобождение всех ресурсов

#### Функции инициализации
- `setup_logging(config)` - настройка системы логирования
- `main()` - главная асинхронная функция приложения
- `run()` - функция запуска с обработкой исключений

## 🎯 Принципы SOLID в Проекте

### Single Responsibility Principle (SRP)
- Каждый класс отвечает за одну конкретную функциональность
- `ConfigManager` - только конфигурация
- `ExcelProcessor` - только обработка Excel
- `TopExApiClient` - только работа с API

### Open/Closed Principle (OCP)
- Интерфейсы позволяют добавлять новые реализации без изменения существующего кода
- Легко добавить новый формат файлов или новый API клиент
- Новые типы генераторов результатов добавляются без изменений

### Liskov Substitution Principle (LSP)
- Все реализации полностью заменяемы через интерфейсы
- Любой IApiClient может заменить TopExApiClient
- Любой IResultGenerator может заменить ExcelResultGenerator

### Interface Segregation Principle (ISP)
- Интерфейсы содержат только необходимые методы
- Клиенты зависят только от нужной функциональности
- Нет принуждения к реализации ненужных методов

### Dependency Inversion Principle (DIP)
- Высокоуровневые модули (сервисы) зависят от абстракций
- Низкоуровневые модули (реализации) реализуют абстракции  
- Внедрение зависимостей через конструкторы

## 📝 Принцип DRY (Don't Repeat Yourself)

### Переиспользование кода:
- Общие настройки вынесены в конфигурацию
- Повторяющиеся паттерны обработки ошибок в базовых классах
- Единая система логирования для всех компонентов
- Общие модели данных используются во всех слоях

### Централизованные настройки:
- Все константы и настройки в ConfigManager
- Поддерживаемые форматы файлов определены в одном месте
- Весовые категории настраиваются через конфигурацию
- Названия колонок Excel централизованы в ExcelProcessor

## 🛠️ Установка и Запуск

### Требования
- Python 3.9+
- pip или poetry для управления зависимостями

### Установка зависимостей
```bash
pip install -r requirements.txt
```

### Настройка переменных окружения
```bash
export TELEGRAM_BOT_TOKEN="your_telegram_bot_token"
export TOPEX_EMAIL="your_topex_email"
export TOPEX_PASSWORD="your_topex_password"
```

### Дополнительные настройки (опционально)
```bash
export MAX_FILE_SIZE=10485760  # 10MB
export API_TIMEOUT=30
export LOG_LEVEL=INFO
export WEIGHT_CATEGORIES="500,1000,2000,5000,10000"
```

### Запуск приложения
```bash
python src/main.py
```

## 📊 Использование

### Команды бота
- `/start` - приветственное сообщение и инструкции
- `/help` - подробная справка по использованию

### Формат Excel файла
Файл должен содержать колонки:
- **Откуда** (или "отправитель", "from", "origin") - город отправления
- **Куда** (или "получатель", "to", "destination") - город назначения

### Процесс работы
1. Пользователь отправляет Excel файл боту
2. Бот обрабатывает файл и извлекает маршруты
3. Для каждого маршрута рассчитывается стоимость доставки по 5 весовым категориям
4. Находятся самые выгодные предложения для каждого веса
5. Создается Excel файл с результатами и отправляется пользователю

### Структура результатов
Excel файл содержит:
- **Сводка** - общая статистика расчетов
- **Результаты** - лучшие предложения для каждого веса
- **Вес_0.5кг**, **Вес_1кг**, etc. - детализация по весовым категориям

## 🔧 Разработка

### Добавление нового API клиента
1. Создать класс, реализующий `IApiClient`
2. Добавить создание в `ApplicationContainer`
3. Обновить конфигурацию при необходимости

### Добавление нового формата файлов
1. Расширить `IExcelProcessor` при необходимости
2. Обновить реализацию `ExcelProcessor`
3. Добавить поддержку в `get_supported_column_names`

### Добавление нового формата вывода
1. Добавить формат в `IResultGenerator.get_supported_formats`
2. Реализовать генерацию в `ExcelResultGenerator`
3. Обновить метод `generate_result_file`

## 📈 Мониторинг и Логирование

### Система логирования
- Настраивается через переменные окружения
- Поддержка различных уровней логирования
- Логи в файл и консоль одновременно
- Структурированное логирование с метками времени

### Статистика работы
- Количество обработанных файлов
- Количество рассчитанных маршрутов  
- Количество вызовов API
- Время работы приложения
- Процент успешных расчетов

### Обработка ошибок
- Graceful обработка всех типов ошибок
- Пользовательские уведомления об ошибках
- Подробное логирование для отладки
- Автоматическое восстановление после временных сбоев

## 🧪 Тестирование

### Модульные тесты
Каждый компонент может тестироваться независимо благодаря использованию интерфейсов:
- Тесты конфигурации с моковыми переменными окружения
- Тесты Excel процессора с тестовыми файлами
- Тесты API клиента с моковыми HTTP ответами
- Тесты генератора результатов с тестовыми данными

### Интеграционные тесты
- Тестирование полного цикла обработки файла
- Проверка взаимодействия с реальным API
- Валидация генерируемых Excel файлов

## 📚 Дополнительная Информация

### Архитектурные решения
- **Чистая архитектура** для разделения бизнес-логики и инфраструктуры
- **Внедрение зависимостей** для тестируемости и гибкости
- **Асинхронное программирование** для производительности
- **Типизация** для надежности кода

### Производительность
- Асинхронные HTTP запросы к API
- Кэширование токенов аутентификации
- Оптимизированная обработка Excel файлов
- Rate limiting для соблюдения ограничений API

### Безопасность
- Безопасное хранение токенов в переменных окружения
- URL-кодирование токенов API
- Валидация всех входных данных
- Логирование без секретной информации

### Масштабируемость
- Модульная архитектура позволяет легко добавлять новые компоненты
- Поддержка различных API провайдеров через интерфейсы
- Конфигурируемые лимиты и таймауты
- Готовность к горизонтальному масштабированию

---

*Проект разработан с соблюдением лучших практик Python разработки и принципов чистого кода.*